<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Roulette Game</title>
    <style>
      /* Add your CSS styling here */
      body {
        font-family: Arial, sans-serif;
        text-align: center;
      }

      .triangle {
        width: 0;
        height: 0;
        border-left: 20px solid transparent;
        border-right: 20px solid transparent;
        border-top: 20px solid #000; /* Change to border-top */
        margin: auto;
      }
      .roulette-wheel {
        display: block;
        margin: auto;
        margin-bottom: 15px;
        width: 400px;
        height: 400px;
        border: 2px solid #000;
        border-radius: 50%; 
        position: relative;
        transition: transform 5s ease-in-out;
        background-image: url("https://pngimg.com/d/roulette_PNG17.png"); /* Set the image URL */
        background-size: cover; /* Make the image cover the entire wheel */
      }
      .bet-input {
        width: 80px;
        padding: 5px;
        margin: 10px;
      }
      #result {
      /* Center the result and make it larger */
      color: white;
      background-color: rgba(0, 0, 0, 1); /* Semi-transparent black background for readability */
      border-radius: 10px; /* Rounded corners for the box */
      text-align: center;
      font-size: 1.8vw; /* Font size relative to the viewport width */
    }
      #token-balance {
        text-align: center;
        font-size: 20px;
        margin-top: 30px;
        margin-bottom: 5px;
      } 
      #user-input {
        text-align: center;
        width: 15%; /* Set the desired width */
        margin-top: 10px;
        margin-bottom: 10px;
      }
      #info-button {
        position: absolute;
        right: 10px;
        padding: 10px 20px;
        background-color: #000;
        margin-top: 40px; 
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
      }
      #buy-flag-button {
        position: absolute;
        left: 10px;
        padding: 20px 20px;
        background-color: gold;
        font-size: medium;
        margin-top: 40px; 
        color: black;
        border: none;
        border-radius: 10px;
        cursor: pointer;
      }
      #error {
        color: red; /* Text color */
        background-color: #ffdddd; /* Light red background */
        border: 1px solid red; /* Red border */
        padding: 10px; /* Some padding */
        margin-top: 10px; /* Space above the box */
        border-radius: 5px; /* Rounded corners */
        display: none; /* Hide by default */
        text-align: center; /* Center the text */
      }
    </style>
  </head>
  <body>
    <button id="info-button" onclick="window.location.href='/info';">INFO</button>
    <button id="buy-flag-button" onclick="window.location.href='/info';">BUY FLAG</button>
    <p id="result">Result: Click to Play!</p>
    <div class="roulette-table">
      <div class="triangle"></div>
      <div class="roulette-wheel" id="wheel">
        <div class="pocket" style="transform: rotate(0deg)"></div>
        <div class="pocket black-pocket" style="transform: rotate(10deg)"></div>
      </div>

      <div id="error" style="color: red;"></div>
      <div id="token-balance"><b>Tokens:</b> 2000</div>

      <form id="bet-form">
        <input type="number" id="user-input" name="user-bet-amount" placeholder="Bet Amount" required/>
        <input type="radio" id="red" name="bet" value="red" /> Red
        <input type="radio" id="black" name="bet" value="black" /> Black
        <input type="radio" id="green" name="bet" value="green" /> Green
        <input type="submit" value="Submit" />
      </form>
    </div>

    <script>

      function getRandom(min, max) { 
          return Math.floor(Math.random() * (max - min + 1)) + min; 
      }

      // Hashmap of each number on the wheel and their ranges
      const ranges = {
          "1": [6, 13], "13": [15, 23], "36": [25, 32], "24": [34, 42],
          "3": [44, 51], "15": [53, 60], "34": [62, 70], "22": [72, 79],
          "5": [81, 89], "17": [91, 99], "32": [101, 108], "20": [110, 118],
          "7": [119, 127], "11": [129, 137], "30": [139, 146], "26": [148, 155],
          "9": [157, 165], "28": [167, 174], "0": [176, 184], "2": [186, 193],
          "14": [195, 203], "35": [205, 212], "23": [214, 221], "4": [224, 231],
          "16": [233, 241], "33": [243, 250], "21": [251, 260], "6": [263, 269],
          "18": [271, 279], "31": [281, 288], "19": [290, 298], "8": [300, 307],
          "12": [309, 316], "29": [318, 326], "35": [328, 335], "10": [337, 345],
          "27": [347, 354], "00": [360, 360]
      };

      let degs = {};
      for (let key in ranges) {
          let range = ranges[key];
          degs[key] = range[1] === 360 ? 360 : getRandom(range[0], range[1]);
      }

      const resultText = document.getElementById("result");
      const tokenBalanceElement = document.getElementById("token-balance");
      const wheel = document.getElementById("wheel");
      const betForm = document.getElementById("bet-form");
      const error = document.getElementById("error");

      let currentRotation = 0; // Store the current rotation degree

      // Function to spin the wheel
      function spinWheel() {
      // Disable user interaction while spinning
      wheel.style.pointerEvents = "none";

      // Make an AJAX request to fetch degrees and number from Flask
      fetch("/spin")
        .then((response) => response.json())
        .then((data) => {
          if (data.error) {
            document.getElementById('error').textContent = data.error;
            document.getElementById('error').style.display = 'block'; 
          }
          const number = data.number;
          const tokens = data.tokens; // This contains the updated tokens

          // Calculate the new rotation degree by adding to the current rotation
          let dst = currentRotation > 360 ? currentRotation % 360 : currentRotation;
          currentRotation += (360 * 4 + (degs[number] - dst));

          // Rotate the wheel for a fixed duration (5 seconds)
          wheel.style.transition = "transform 5s ease-in-out";
          wheel.style.transform = `rotate(${currentRotation}deg)`;  

          // After a delay, show the result and re-enable user interaction
          setTimeout(() => {
            resultText.textContent = `Result: ${number}`;
            tokenBalanceElement.textContent = `Tokens: ${tokens}`; // Update the tokens display
            wheel.style.pointerEvents = "auto";
          }, 5500);
        });
    }

      // Automatically spin the wheel every 20 seconds
      setInterval(spinWheel, 20000);

      // Initial spin to start the automatic spinning
      spinWheel();
      updateTokenBalance();
    </script>

    <script>
      betForm.addEventListener("submit", function (event) {
        event.preventDefault(); // Prevent the default form submission behavior

        // Get the selected bet option
        const selectedBet = betForm.querySelector('input[name="bet"]:checked');
        const betAmt = document.getElementById('user-input').value;

        // Check if a bet option is selected
        if (selectedBet && betAmt) {
          // Construct the URL for the POST request
          const url = `/userInput`;

          // Create a JSON object with the selected bet
          const postData = {
            user_color: selectedBet.value,
            bet_amount: betAmt
          };

          // Make a POST request to the constructed URL
          fetch(url, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(postData),
          })
            .then((response) => response.json())
            .then((data) => {
              console.log(data);
              bet_amount: 0;
              user_color: '';

            })
            .catch((error) => {
              console.error(error);
            });
        } else {
          alert("Please select a color and enter a bet amount.");
        }
      });
    </script>
  </body>
  <p>Wheel spins every 20 seconds</p>
</html>
